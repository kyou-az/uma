<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <!--  グラフライブラリの読み込み  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
    <div>
        <div class="row align-items-end">
            <div class="col">
                <label for="speed" class="form-label">スピード</label>
                <input type="number" class="form-control" id="speed" placeholder="入力">
            </div>
            <div class="col">
                <label for="speedRank" class="form-label">スピードRank</label>
                <select class="form-control" id="speedRank">
                    <option value="">--</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="D">F</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="stamina" class="form-label">スタミナ</label>
                <input type="number" class="form-control" id="stamina" placeholder="">
            </div>
            <div class="col">
                <label for="staminaRank" class="form-label">スタミナRank</label>
                <select class="form-control" id="staminaRank">
                    <option value="">--</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="D">F</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="power" class="form-label">パワー</label>
                <input type="number" class="form-control" id="power" placeholder="">
            </div>
            <div class="col">
                <label for="powerRank" class="form-label">パワーRank</label>
                <select class="form-control" id="powerRank">
                    <option value="">--</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="D">F</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="guts" class="form-label">根性</label>
                <input type="number" class="form-control" id="guts" placeholder="">
            </div>
            <div class="col">
                <label for="gutsRank" class="form-label">根性Rank</label>
                <select class="form-control" id="gutsRank">
                    <option value="">--</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="D">F</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="intelligence" class="form-label">賢さ</label>
                <input type="number" class="form-control" id="intelligence" placeholder="">
            </div>
            <div class="col">
                <label for="intelligenceRank" class="form-label">賢さRank</label>
                <select class="form-control" id="intelligenceRank">
                    <option value="">--</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="D">F</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="selectedStatus" class="form-label">選択されたステータス</label>
                <select class="form-control" id="selectedStatus">
                    <option value="">--</option>
                    <option value="speed">スピード</option>
                    <option value="stamina">スタミナ</option>
                    <option value="power">パワー</option>
                    <option value="guts">根性</option>
                    <option value="intelligence">賢さ</option>
                </select>
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <label for="factor" class="form-label">因子</label>
                <input type="number" class="form-control" id="factor" placeholder="">
            </div>
        </div>

        <div class="row align-items-end">
            <div class="col">
                <button id="create" type="button" class="btn btn-primary">追加</button>
            </div>
        </div>
    </div>

    <table class="table">

        <thead>
            <tr>
                <th scope="col">SP</th>
                <th scope="col">SP RANK</th>
                <th scope="col">ST</th>
                <th scope="col">ST RANK</th>
                <th scope="col">PW</th>
                <th scope="col">PW RANK</th>
                <th scope="col">GUTS</th>
                <th scope="col">GUTS RANK</th>
                <th scope="col">INT</th>
                <th scope="col">INT RANK</th>
                <th scope="col">選択されたステータス</th>
                <th scope="col">因子</th>
            </tr>
        </thead>

        <tbody id="list">
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
        <div style="width: 300px">
            <h3>SS</h3>
            <canvas id="myChartSS" width="400" height="400"></canvas>
        </div>

        <div style="width: 300px">
            <h3>S</h3>
            <canvas id="myChartS" width="400" height="400"></canvas>
        </div>

        <div style="width: 300px">
            <h3>A</h3>
            <canvas id="myChartA" width="400" height="400"></canvas>
        </div>

        <div style="width: 300px">
            <h3>B</h3>
            <canvas id="myChartB" width="400" height="400"></canvas>
        </div>
    </div>



</div>
</body>
<script>
    class Summary {
        constructor(
            speed,
            stamina,
            power,
            guts,
            intelligence,
            speedRank,
            staminaRank,
            powerRank,
            gutsRank,
            intelligenceRank,
            selectedStatus,
            factor
        ) {
            this.speed = speed; // スピード
            this.stamina = stamina;
            this.power = power;
            this.guts = guts;
            this.intelligence = intelligence;
            this.speedRank = speedRank;
            this.staminaRank = staminaRank;
            this.powerRank = powerRank;
            this.gutsRank = gutsRank;
            this.intelligenceRank = intelligenceRank;
            this.selectedStatus = selectedStatus;
            this.factor = factor;
        }

        getSelectedStatusValue() {
            switch (this.selectedStatus) {
                case 'speed':
                    return this.speed;
                case 'stamina':
                    return this.stamina;
                case 'power':
                    return this.power;
                case 'guts':
                    return this.guts;
                case 'intelligence':
                    return this.intelligence;
            }
        }

        getSelectedStatusRank() {
            switch (this.selectedStatus) {
                case 'speed':
                    return this.speedRank;
                case 'stamina':
                    return this.staminaRank;
                case 'power':
                    return this.powerRank;
                case 'guts':
                    return this.gutsRank;
                case 'intelligence':
                    return this.intelligenceRank;
            }
        }
    }

    class SummariesCollection {
        constructor(summaries = []) {
            this.summaries = summaries
        }

        append(summary) {
            this.summaries.push(summary)
        }

        getBySelectedStatus(selectedStatus) {
            return this.summaries.filter(function (summary) {
                if (summary.selectedStatus === selectedStatus) return summary;
            });
        }

        displayGraph(rank) {
            // Summariesの一覧を、選択済みのStatusのランクと、因子を持つオブジェクトに変換する。
            const convertedSummaries = this.summaries.map(function (summary) {
                return {
                    factor: summary.factor,
                    rank: summary.getSelectedStatusRank()
                }
            })

            // 上記で変換したオブジェクトリストから、集計したいランクだけのリストを抽出する。
            const filteredList = convertedSummaries.filter(function (item) {
                if (item.rank === rank) return true;
            })

            // 抽出したリストから、星の数ごとの個数を集計する。
            const factorCount = {
                one: 0,
                two: 0,
                three: 0,
            }

            filteredList.forEach(function (item) {
                if (item.factor === "1") {
                    factorCount.one++;
                } else if (item.factor === "2") {
                    factorCount.two++;
                } else if (item.factor === "3") {
                    factorCount.three++;
                }
            })

            // 集計結果からグラフを描画
            this.makeGraph(rank, factorCount)
        }

        makeGraph(rank, factorCount) {
            // 集計したデータを元に、グラフに描画する。
            var ctx = document.getElementById(`myChart${rank}`).getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['★(10%)', '★★(20%)', '★★★(70%)'],
                    datasets: [{
                        label: '因子比率',
                        data: [factorCount.one, factorCount.two, factorCount.three],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        display() {
            $('#list').empty();
            this.summaries.forEach(function (summary) {



                $('#list').append(`
                    <tr>
                        <td>${summary.speed}</td>
                        <td>${summary.speedRank}</td>
                        <td>${summary.stamina}</td>
                        <td>${summary.staminaRank}</td>
                        <td>${summary.power}</td>
                        <td>${summary.powerRank}</td>
                        <td>${summary.guts}</td>
                        <td>${summary.gutsRank}</td>
                        <td>${summary.intelligence}</td>
                        <td>${summary.intelligenceRank}</td>
                        <td>${summary.selectedStatus}</td>
                        <td>${summary.factor}</td>
                    </tr>
                `);
            })
        }
    }

    let data = localStorage.getItem('summaries');
    data = JSON.parse(data);

    const summariesCollection = new SummariesCollection();

    if (data) {
        data.summaries.forEach(function (summary) {
            summariesCollection.append(new Summary(
                summary.speed,
                summary.stamina,
                summary.power,
                summary.guts,
                summary.intelligence,
                summary.speedRank,
                summary.staminaRank,
                summary.powerRank,
                summary.gutsRank,
                summary.intelligenceRank,
                summary.selectedStatus,
                summary.factor
            ));
        });

        summariesCollection.display();
        summariesCollection.displayGraph('A');
        summariesCollection.displayGraph('B');
        summariesCollection.displayGraph('SS');
        summariesCollection.displayGraph('S');
    }



    $('#create').click(function () {
        const speed = $('#speed').val();
        const stamina = $('#stamina').val();
        const power = $('#power').val();
        const guts = $('#guts').val();
        const intelligence = $('#intelligence').val();
        const speedRank = $('#speedRank').val();
        const staminaRank = $('#staminaRank').val();
        const powerRank = $('#powerRank').val();
        const gutsRank = $('#gutsRank').val();
        const intelligenceRank = $('#intelligenceRank').val();
        const selectedStatus = $('#selectedStatus').val();
        const factor = $('#factor').val();

        const summary = new Summary(
            speed,
            stamina,
            power,
            guts,
            intelligence,
            speedRank,
            staminaRank,
            powerRank,
            gutsRank,
            intelligenceRank,
            selectedStatus,
            factor
        );

        summariesCollection.append(summary);
        localStorage.setItem('summaries', JSON.stringify(summariesCollection));

        summariesCollection.display()
    })
</script>
</html>